---
title: "Raster Template"
description: |
  Learn how to use a raster template from the `{d6geodata}` package und how to multiple/expand it. In the end we will rasterize a shapefile with the raster and have a look into different extraction functions.
preview: ./img/wiki/preview-rastertemplate.png
categories:
  - tutorial
  - spatial
  - sf
  - terra
author:
  - name: Moritz Wenzler-Meya
    affiliation: IZW Berlin
    affiliation_url: https://ecodynizw.github.io/
date: 2023-09-22
output:
  distill::distill_article:
    self_contained: false
    toc: true
draft: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) ## keep this, add other settings if needed
```

## Setup {#setup}

Install the `{d6geodata}` library and load all necessary libraries. 

```{r}
#remotes::install_github("EcoDynIZW/d6geodata")
library(d6geodata)
library(terra)
library(ggplot2)
library(sf)
library(patchwork)
library(dplyr)

theme_set(
  theme(axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8))
) 
```


## Raster Template {#template}

First get the template raster. The origin is the extent of Berlin with the projection laea (EPSG:3035).

```{r template}
temp <- d6geodata::temp_ras(1000) # resolution is 1000m
values(temp) <- 1 # set a dummy value for visualization purposes 

temp
```

We load Berlin borders from the cloud to show the borders  

```{r berlin borders}
berlin <- d6geodata::get_geodata(data_name = "districs_berlin_2022_poly_03035_gpkg",
                                 path_to_cloud = "E:/PopDynCloud",
                                 download_data = FALSE) %>% 
  st_union() %>% # using `st_union()` to combine  
  st_cast("POLYGON")

p_berlin <- geom_sf(data = berlin, alpha = 0, color = "black", lwd = 0.7)
```


```{r plot template}
p1 <- d6geodata::plot_qualitative_map(temp) # you can use this build-in plot function from the `{d6geodata}` package 
 
p1 + p_berlin
```

## Expand Raster {#expand}

### Expand On All Sides

If you want to expand the raster on all size (similar to a buffer around a polygon) you can just add cells to all sides. You can do this by adding an integer number in the y argument in the function `extend` of the `{terra}` package.

```{r}
temp_exp_all <- terra::extend(x = temp, # template raster as input
                              y = 10, # number of cells to add
                              fill = 2) # value for new cells

p2 <- d6geodata::plot_qualitative_map(temp_exp_all)
p2 + p_berlin
```

### Expand On Two Sides

In this case you can add cells on two opposite sides.

```{r}
temp_exp_tb_sides <- terra::extend(x = temp,
                                   y = c(10, 0), # add 10 cells on top and below
                                   fill = 2,)
p3 <- d6geodata::plot_qualitative_map(temp_exp_tb_sides)
p3 + p_berlin
```

### Expand On One Side With A Costum Extent

In this case we use a workaround by using a costum extent. We are adding on the left (western) side cells by using the xmin of the larger extend. Xmax, ymin, ymax are from the given extent.

```{r}
temp_exp_1_sides <- terra::extend(x = temp,
                                  y = ext(ext(temp_exp_all)[1], # xmin
                                          ext(temp)[2], # xmax
                                          ext(temp)[3], # ymin
                                          ext(temp)[4]),# ymax
                                  fill = 2)

p4 <- d6geodata::plot_qualitative_map(temp_exp_1_sides)
p4 + p_berlin
```

### Combined Plot

Here you see a combination of all plots made to compare them directly.

```{r, preview = TRUE}
(p1 + p_berlin + theme(legend.position="none") + p2 + p_berlin) / (p3 + p_berlin + p4 + p_berlin) + 
  plot_layout(guides = "collect") +
   plot_annotation(tag_levels = "1", tag_prefix = "(P", tag_suffix = ")")
```

## Rasterize Vector Data {#rasterize}

With `vect()` you can make a spatVector (a kind of shapfile) out of an extent object.
Afterwards, we can use this spatVector to rasterize the data. This works similar with an sf object.

```{r plot}
temp_vec <- terra::vect(ext(temp), crs(temp)) # spatVector out of smalest raster extent

temp_rast <- rasterize(temp_vec, # vector data
                       temp_exp_all %>% disagg(10), 
                       # raster data with larger extent, disaggregated to 100m 
                       background = 2) # set to 2 to visualize the difference

temp_rast
```

### Rasterized Plot

```{r}
d6geodata::plot_qualitative_map(temp_rast)
```

## Extract With Vector Data {#extract}

Sometimes you want to know the values from vector data over a raster layer. There are several ways to this but the easiest way is to 'just' extract the values laying under the vector data.

For this, you can use any vector data with the same projection and extent to extract values from a raster. The `extract()` function uses the raster as first input and the vector data as second. Depending on the type of data you are using you can define a function for the extraction like min, max or mean. 'Cells' gives you the call ID, 'xy' the coordinates and 'ID' the row number of your extraction.

### Line For Extraction

```{r}
pts <- tibble(x = c(4528790, 4576890), # a point out of two coordinates from the raster
              y = c(3271740, 3272140))

dummy_line <- st_as_sf(pts,             # a line made out of the point data
                       coords = c("x", "y"),
                       crs = 3035,
                       sf_column_name = "geometry",
                       remove = FALSE) %>% 
  summarise(do_union = FALSE) %>% 
  st_cast("LINESTRING") %>% 
  mutate(id = 1)
```

### Plot Of Raster And Line

```{r}
p5 <- d6geodata::plot_qualitative_map(temp_rast) + 
  geom_sf(data = dummy_line)

p5

```

### Extraction From Line

Here we finally extract the data and view the result with a table.

```{r}
ext_tab <- terra::extract(x = temp_rast, 
               y = dummy_line, 
               fun=NULL, 
               method="simple", 
               cells=FALSE, 
               xy=FALSE,
               ID=TRUE
               )
```

As you can see, the largest part of the line lays within the purple area and 

```{r}
table(ext_tab$layer)
```

## Summary {#summary}

You learned how to extend a raster and how to extract data from a raster by using `{sf}` and `{terra}`. Of course there are several ways to do this, but this the most convenient way!!!
